<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title th:text="${servicioRequestDTO.idServicio != null} ? 'Editar Servicio' : 'Nuevo Servicio'">Formulario Servicio</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/form.css}">
</head>
<body>

<form th:action="${servicioRequestDTO.idServicio != null} ? @{/servicio/update/{idServicio}(idServicio=${servicioRequestDTO.idServicio})} : @{/servicio/save}" method="post" th:object="${servicioRequestDTO}">
    <h1 th:text="${servicioRequestDTO.idServicio != null} ? 'Editar Servicio' : 'Nuevo Servicio'"></h1>
    <input type="hidden" th:if="${servicioRequestDTO.idServicio != null}" th:field="*{idServicio}" />

    <div class="input-group">
        <label>Nombre:</label>
        <input type="text" th:field="*{nombre}" placeholder="Ingresa el nombre del servicio" required />
        <div th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}"></div>
    </div>

    <div class="input-group">
        <label>Duración:</label>
        <input type="number" th:field="*{duracion}" step="15" min="15" placeholder="Duración en minutos" required />
        <div th:if="${#fields.hasErrors('duracion')}" th:errors="*{duracion}"></div>
    </div>

    <div class="input-group">
        <label>Requiere Empleado:</label>
        <input type="checkbox" th:field="*{requiereEmpleado}" />
        <div th:if="${#fields.hasErrors('requiereEmpleado')}" th:errors="*{requiereEmpleado}"></div>
    </div>

    <fieldset>
        <legend>Asignar Empleados</legend>
        <div class="servicios-container">
            <div th:each="empleado : ${empleados}" class="servicio-item">
                <label>
                    <input type="checkbox" th:field="*{idEmpleados}" th:value="${empleado.idPersona}" />
                    <span th:text="${empleado.nombre} + ' ' + ${empleado.apellido} + ' (' + ${empleado.puesto} + ')'"></span>
                </label>
            </div>
            <div th:if="${#fields.hasErrors('idEmpleados')}" th:errors="*{idEmpleados}"></div>
        </div>
    </fieldset>

    <div class="input-group">
        <label>Ubicación:</label>
        <select th:field="*{idUbicacion}" required>
            <option value="">Seleccione una ubicación</option>
            <option th:each="ubicacion : ${ubicaciones}"
                    th:value="${ubicacion.idUbicacion}"
                    th:text="${ubicacion.localidad} + ', ' + ${ubicacion.calle} + ' ' + ${ubicacion.numero}">
            </option>
        </select>
        <div th:if="${#fields.hasErrors('idUbicacion')}" th:errors="*{idUbicacion}"></div>
    </div>

    <fieldset>
        <legend>Disponibilidades del Servicio</legend>
        <h3>Selecciona los días y horarios</h3>
        <table id="tablaHorarios" class="disponibilidades-table">
            <thead>
                <tr>
                    <th>Día</th>
                    <th>Hora de inicio</th>
                    <th>Hora de finalización</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dinámicamente agregado -->
            </tbody>
        </table>
        <button type="button" class="btn-add" id="agregarHorario">+ Agregar</button>

        <div th:if="${servicioRequestDTO.idServicio != null}">
            <button type="button" class="btn-remove" id="btnToggleEliminar">- Eliminar Disponibilidad</button>

            <div id="elimDisponibilidades" style="display:none;">
                <p><b>Disponibilidades existentes:</b></p>
                <table>
                    <thead>
                        <tr>
                            <th>Eliminar</th>
                            <th>Día</th>
                            <th>Hora de inicio</th>
                            <th>Hora de finalización</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="disp : ${servicioRequestDTO.disponibilidades}">
                            <td><input type="checkbox" name="eliminarDisponibilidades" th:value="${disp.idDisponibilidad}" /></td>
                            <td>
                                <span th:switch="${disp.diaSemana}">
                                    <span th:case="'MONDAY'">Lunes</span>
                                    <span th:case="'TUESDAY'">Martes</span>
                                    <span th:case="'WEDNESDAY'">Miércoles</span>
                                    <span th:case="'THURSDAY'">Jueves</span>
                                    <span th:case="'FRIDAY'">Viernes</span>
                                    <span th:case="'SATURDAY'">Sábado</span>
                                    <span th:case="'SUNDAY'">Domingo</span>
                                    <span th:case="*">[[${disp.diaSemana}]]</span>
                                </span>
                            </td>
                            <td th:text="${#temporals.format(disp.horaInicio, 'HH:mm')}"></td>
                            <td th:text="${#temporals.format(disp.horaFin, 'HH:mm')}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </fieldset>

    <button type="submit">Guardar Servicio</button>
    <div class="volver-link mt-3">
        <a th:href="@{/servicio/admin/list}">Volver</a> 
        <a th:href="@{/ubicacion/form}">Crear nueva ubicación</a>
    </div>
</form>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const requiereEmpleadoCheckbox = document.querySelector("input[name='requiereEmpleado']");
        const empleadosCheckboxes = document.querySelectorAll("input[name='idEmpleados']");

        function toggleEmpleados() {
            const habilitado = requiereEmpleadoCheckbox.checked;
            empleadosCheckboxes.forEach(checkbox => checkbox.disabled = !habilitado);
        }

        // Ejecutar al cargar la página
        toggleEmpleados();

        // Escuchar cambios en el checkbox "Requiere Empleado"
        requiereEmpleadoCheckbox.addEventListener("change", toggleEmpleados);
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    let horarioIndex = 0;
    const tbody = document.getElementById('tablaHorarios').querySelector('tbody');
    const btnAgregar = document.getElementById('agregarHorario');
    
    btnAgregar.addEventListener('click', function () {
        const fila = document.createElement('tr');

        // Celda para el botón del día y su lista desplegable
        const celdaDia = document.createElement('td');
        celdaDia.innerHTML = `
            <button type="button" class="btn-dia" onclick="toggleDropdown(this)">Día</button>
            <div class="dropdown" style="display: none;">
                <div onclick="selectDay(this, 'Lunes', 'MONDAY')">Lunes</div>
                <div onclick="selectDay(this, 'Martes', 'TUESDAY')">Martes</div>
                <div onclick="selectDay(this, 'Miércoles', 'WEDNESDAY')">Miércoles</div>
                <div onclick="selectDay(this, 'Jueves', 'THURSDAY')">Jueves</div>
                <div onclick="selectDay(this, 'Viernes', 'FRIDAY')">Viernes</div>
                <div onclick="selectDay(this, 'Sábado', 'SATURDAY')">Sábado</div>
                <div onclick="selectDay(this, 'Domingo', 'SUNDAY')">Domingo</div>
            </div>
            <input type="hidden" name="disponibilidades[${horarioIndex}].diaSemana" class="diaHidden"/>
        `;
        fila.appendChild(celdaDia);

        // Celdas para hora de inicio y fin
        fila.innerHTML += `<td><input type="time" name="disponibilidades[${horarioIndex}].horaInicio" required /></td>`;
        fila.innerHTML += `<td><input type="time" name="disponibilidades[${horarioIndex}].horaFin" required /></td>`;

        tbody.appendChild(fila);
        horarioIndex++;
    });
});

function toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
}

function selectDay(element, dayDisplay, dayValue) {
    const dropdownDiv = element.parentElement;
    const button = dropdownDiv.previousElementSibling;
    const hiddenInput = dropdownDiv.nextElementSibling;
    
	// Actualiza la visualización del botón y asigna el valor (enum) al input oculto
    button.innerText = dayDisplay;
    hiddenInput.value = dayValue;
	// Oculta el menú desplegable
    dropdownDiv.style.display = "none";
}

// Botón para togglear la sección de eliminación de disponibilidades
document.addEventListener("DOMContentLoaded", function () {
    const btnToggle = document.getElementById("btnToggleEliminar");
    if(btnToggle){
        btnToggle.addEventListener("click", function(){
            const div = document.getElementById("elimDisponibilidades");
            div.style.display = (div.style.display==='none' || div.style.display==='') ? 'block' : 'none';
        });
    }
});
</script>
</body>

</html>
